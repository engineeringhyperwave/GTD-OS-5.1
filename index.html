<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTD OS v5.1 - The Why Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #2563eb; }
        .stuck-project { border-left: 6px solid #ef4444 !important; }
        .tab-active { color: var(--primary); border-right: 4px solid var(--primary); background: #eff6ff; font-weight: bold; }
        .area-tag { background: #f1f5f9; color: #475569; font-size: 9px; padding: 2px 8px; border-radius: 4px; font-weight: 800; text-transform: uppercase; }
        body { font-family: 'Inter', system-ui, sans-serif; }
    </style>
</head>
<body class="bg-slate-50 flex h-screen overflow-hidden text-slate-900 text-sm">

<!-- ä¾§è¾¹æ ä¿æŒç®€æ´ -->
<aside class="w-72 border-r bg-white flex flex-col h-full flex-shrink-0">
    <div class="p-8"><h1 class="text-2xl font-black tracking-tighter text-blue-600 italic">GTD OS 5.1</h1></div>
    <div class="px-6 mb-4">
        <input type="text" id="globalSearch" oninput="render()" placeholder="ğŸ” æœç´¢æ‰€æœ‰ç»´åº¦..." class="w-full bg-slate-100 border-none rounded-xl p-2 text-xs outline-none">
    </div>
    <nav class="flex-1 overflow-y-auto px-4 space-y-1">
        <button onclick="setFilter('status','inbox')" id="btn-inbox" class="w-full text-left px-4 py-2 rounded-lg transition flex justify-between">ğŸ“¥ æ”¶ä»¶ç®± <span id="badge-inbox"></span></button>
        <button onclick="setFilter('status','projects')" id="btn-projects" class="w-full text-left px-4 py-2 rounded-lg transition flex justify-between">ğŸ“¦ é¡¹ç›® (10k') <span id="badge-stuck"></span></button>
        <button onclick="setFilter('status','next')" id="btn-next" class="w-full text-left px-4 py-2 rounded-lg transition">ğŸš€ ä¸‹ä¸€æ­¥ (Ground)</button>
        <button onclick="setFilter('status','waiting')" id="btn-waiting" class="w-full text-left px-4 py-2 rounded-lg transition">â³ ç­‰å¾…æ¸…å•</button>
        <button onclick="setFilter('status','someday')" id="btn-someday" class="w-full text-left px-4 py-2 rounded-lg transition">ğŸ’¤ ä¹Ÿè®¸/å­µåŒ–</button>
        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-2 mt-6 mb-2">æ‰§è¡Œæƒ…å¢ƒ (Contexts)</div>
        <div id="context-list" class="space-y-0.5"></div>
    </nav>
    <div class="p-4 border-t text-center">
        <button onclick="exportData()" class="text-[10px] text-slate-300 hover:text-blue-600">å¤‡ä»½å¤–éƒ¨å¤§è„‘ (JSON)</button>
    </div>
</aside>

<!-- ä¸»åŒº -->
<main class="flex-1 flex flex-col h-full">
    <header class="h-20 bg-white border-b flex items-center px-10 gap-6">
        <input type="text" id="quickInput" placeholder="æ•æ‰... ä½¿ç”¨ @æƒ…å¢ƒ #é¡¹ç›® å¿«é€Ÿæ ‡è®°" class="flex-1 text-lg border-none outline-none">
        <button onclick="alert('æ¯å‘¨å›é¡¾ï¼šè¯·å®¡è§†é¡¹ç›®çš„ PURPOSE æ˜¯å¦ä¾ç„¶å€¼å¾—ä½ æŠ•å…¥ã€‚')" class="text-xs bg-slate-100 px-4 py-2 rounded-full font-bold">é«˜ç©ºå®¡è§†æ¨¡å¼</button>
    </header>
    <section id="listView" class="flex-1 overflow-y-auto p-10 space-y-4 bg-slate-50/50"></section>
</main>

<!-- ç¼–è¾‘/ç†æ¸…æ¨¡æ€æ¡† (æ ¸å¿ƒå‡çº§åŒº) -->
<div id="editModal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[300] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-xl rounded-3xl shadow-2xl overflow-hidden">
        <div class="p-8">
            <textarea id="editTitle" class="w-full text-xl font-bold border-none focus:ring-0 p-0 mb-4 resize-none"></textarea>
            
            <div id="projectMeta" class="mb-6 p-4 bg-blue-50/50 rounded-2xl space-y-3 hidden">
                <div>
                    <label class="text-[10px] font-bold text-blue-400 uppercase">Why? (é¡¹ç›®ç›®çš„/æˆåŠŸæ„¿æ™¯)</label>
                    <input type="text" id="editPurpose" placeholder="å®Œæˆåä¼šæ˜¯ä»€ä¹ˆæ ·ï¼Ÿä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ" class="w-full bg-transparent border-b border-blue-100 py-1 outline-none text-blue-800 italic">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-blue-400 uppercase">Area (æ‰€å±äººç”Ÿé¢†åŸŸ)</label>
                    <input type="text" id="editArea" placeholder="ä¸ªäººæˆé•¿, èŒä¸šè§„åˆ’, å¥åº·, è´¢åŠ¡..." class="w-full bg-transparent border-b border-blue-100 py-1 outline-none font-bold">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 mb-6">
                <button onclick="updateStatus('next')" class="p-2 border rounded-xl hover:bg-slate-50">ğŸš€ ä¸‹ä¸€æ­¥</button>
                <button onclick="updateStatus('projects')" class="p-2 border rounded-xl bg-purple-50 border-purple-100 text-purple-700 font-bold">ğŸ“¦ å‡æ ¼ä¸ºé¡¹ç›®</button>
            </div>

            <div class="flex gap-3">
                <div class="flex-1">
                    <label class="text-[10px] font-bold text-slate-300 uppercase">Context</label>
                    <input type="text" id="editContext" class="w-full bg-slate-50 rounded-lg p-2 outline-none">
                </div>
                <div class="flex-1" id="parentSelectBox">
                    <label class="text-[10px] font-bold text-slate-300 uppercase">Parent Project</label>
                    <select id="editParent" class="w-full bg-slate-50 rounded-lg p-2 outline-none"></select>
                </div>
            </div>
        </div>
        <div class="bg-slate-50 px-8 py-4 flex justify-between">
            <button onclick="deleteItem()" class="text-red-400 text-xs">å½»åº•åˆ é™¤</button>
            <button onclick="saveChanges()" class="bg-blue-600 text-white px-8 py-2 rounded-xl text-xs font-bold">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('gtd_v51_data')) || { items: [], contexts: [] };
    let filter = { type: 'status', value: 'inbox' };
    let editingId = null;

    function save() { localStorage.setItem('gtd_v51_data', JSON.stringify(db)); render(); }

    function render() {
        const view = document.getElementById('listView');
        const query = document.getElementById('globalSearch').value.toLowerCase();
        let list = db.items.filter(i => !i.done && i.text.toLowerCase().includes(query));

        // ä¾§è¾¹æ é«˜äº®
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
        const btn = document.getElementById('btn-' + filter.value) || document.getElementById('btn-ctx-' + filter.value);
        if(btn) btn.classList.add('tab-active');

        // æƒ…å¢ƒåˆ—è¡¨
        document.getElementById('context-list').innerHTML = db.contexts.map(c => `
            <button onclick="setFilter('context','${c}')" id="btn-ctx-${c}" class="w-full text-left px-4 py-1 text-[11px] text-slate-500 hover:bg-slate-100 rounded-lg">${c}</button>
        `).join('');

        let display = (filter.type === 'status') ? list.filter(i => i.status === filter.value) : list.filter(i => i.context === filter.value);

        if(filter.value === 'projects') {
            view.innerHTML = display.map(p => {
                const subs = db.items.filter(i => i.parentId === p.id && !i.done);
                return `
                    <div class="bg-white p-6 rounded-3xl shadow-sm border-2 ${subs.length === 0 ? 'stuck-project' : 'border-transparent'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="text-xl font-black">${p.text}</h3>
                                    ${p.area ? `<span class="area-tag">${p.area}</span>` : ''}
                                </div>
                                ${p.purpose ? `<p class="text-xs text-blue-500 italic mb-4">Why: ${p.purpose}</p>` : ''}
                            </div>
                            <button onclick="openEdit(${p.id})" class="text-[10px] text-slate-300 hover:text-blue-600 font-bold uppercase">Specs</button>
                        </div>
                        <div class="space-y-1.5 border-t pt-4">
                            ${subs.map(s => `<div class="text-xs text-slate-500">â†’ ${s.text}</div>`).join('')}
                            <button onclick="quickAction(${p.id})" class="text-blue-600 text-[10px] font-black mt-2">+ NEXT ACTION</button>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            view.innerHTML = display.map(i => `
                <div class="bg-white p-4 rounded-2xl shadow-sm flex items-center justify-between group">
                    <div class="flex items-center gap-4">
                        <input type="checkbox" onchange="completeItem(${i.id})" class="w-5 h-5 rounded-full border-slate-200">
                        <div>
                            <div class="font-bold text-slate-700">${i.text}</div>
                            <div class="flex gap-2 mt-1">
                                ${i.context ? `<span class="text-[9px] font-bold text-blue-400 uppercase">${i.context}</span>` : ''}
                                ${i.parentId ? `<span class="text-[9px] font-bold text-purple-300 uppercase">ğŸ“Œ ${db.items.find(p=>p.id===i.parentId)?.text}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <button onclick="openEdit(${i.id})" class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-blue-600">âš™ï¸</button>
                </div>
            `).join('');
        }
        document.getElementById('badge-inbox').innerText = db.items.filter(i => i.status === 'inbox' && !i.done).length || '';
    }

    function openEdit(id) {
        editingId = id;
        const item = db.items.find(i => i.id === id);
        document.getElementById('editTitle').value = item.text;
        document.getElementById('editContext').value = item.context || "";
        document.getElementById('editPurpose').value = item.purpose || "";
        document.getElementById('editArea').value = item.area || "";
        
        // åŠ¨æ€å±•ç¤ºé¡¹ç›®å­—æ®µ
        document.getElementById('projectMeta').classList.toggle('hidden', item.status !== 'projects');
        document.getElementById('parentSelectBox').classList.toggle('hidden', item.status === 'projects');

        const sel = document.getElementById('editParent');
        sel.innerHTML = '<option value="">None</option>' + db.items.filter(i => i.status === 'projects' && !i.done && i.id !== id).map(p => 
            `<option value="${p.id}" ${item.parentId === p.id ? 'selected' : ''}>${p.text}</option>`).join('');
        
        document.getElementById('editModal').classList.remove('hidden');
    }

    function saveChanges() {
        const item = db.items.find(i => i.id === editingId);
        item.text = document.getElementById('editTitle').value;
        item.context = document.getElementById('editContext').value;
        item.purpose = document.getElementById('editPurpose').value;
        item.area = document.getElementById('editArea').value;
        item.parentId = parseInt(document.getElementById('editParent').value) || null;
        if(item.context && !db.contexts.includes(item.context)) db.contexts.push(item.context);
        closeModal(); save();
    }

    function updateStatus(status) {
        db.items.find(i => i.id === editingId).status = status;
        saveChanges();
    }

    function setFilter(t, v) { filter = { type: t, value: v }; render(); }
    function completeItem(id) { db.items.find(i => i.id === id).done = true; save(); }
    function closeModal() { document.getElementById('editModal').classList.add('hidden'); }
    function deleteItem() { db.items = db.items.filter(i => i.id !== editingId); closeModal(); save(); }
    function quickAction(pid) { const t = prompt("Next Action?"); if(t) { db.items.push({ id: Date.now(), text: t, status: 'next', parentId: pid, done: false }); save(); } }
    function exportData() { const blob = new Blob([JSON.stringify(db)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `GTD_OS_v5.1.json`; a.click(); }

    document.getElementById('quickInput').addEventListener('keypress', (e) => {
        if(e.key === 'Enter' && e.target.value) {
            db.items.push({ id: Date.now(), text: e.target.value, status: 'inbox', done: false });
            e.target.value = ''; save();
        }
    });

    render();
</script>
</body>
</html>